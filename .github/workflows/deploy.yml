name: Build and Deploy to Yandex Cloud

on:
  push:
    branches: [ deploy_actions ]

env:
  REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
  SERVICE_ACCOUNT_ID: ${{ secrets.YC_SERVICE_ACCOUNT_ID }}
  FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
  SERVICES: '["rag_service", "orchestrator", "tgbot_service", "validator", "yandexgpt_service"]'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Yandex Cloud CLI
      uses: nightstory/setup-yc@v1
      with:
        oauth-token: ${{ secrets.YC_OAUTH_TOKEN }}

    - name: Login to Yandex Container Registr
      uses: docker/login-action@v3
      with:
        registry: cr.yandex
        username: oauth
        password: ${{ secrets.YC_OAUTH_TOKEN }}

    

    - name: Build docker images
      run: |
        SERVICES_ARR=${{ env.SERVICES }}
        for service in $(echo $SERVICES_ARR | jq -r '.[]'); do
          echo "Building Docker image for $service..."
          cd $service
          docker build -t cr.yandex/${{ env.REGISTRY_ID }}/$service:latest .
          docker push cr.yandex/${{ env.REGISTRY_ID }}/$service:latest
          cd ..
          echo "âœ… $service image built and pushed successfully"
        done
            
        done