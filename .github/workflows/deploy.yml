name: Build and Deploy to Yandex Cloud

on:
  push:
    branches: [ deploy_actions ]

env:
  REGISTRY_ID: ${{ secrets.YC_REGISTRY_ID }}
  SERVICE_ACCOUNT_ID: ${{ secrets.YC_SERVICE_ACCOUNT_ID }}
  FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
  SERVICES: '["rag_service", "orchestrator", "tgbot_service", "validator", "yandexgpt_service"]'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install Yandex Cloud CLI
      uses: nightstory/setup-yc@v1
      with:
        oauth-token: ${{ secrets.YC_OAUTH_TOKEN }}

    - name: Login to Yandex Container Registr
      uses: docker/login-action@v3
      with:
        registry: cr.yandex
        username: oauth
        password: ${{ secrets.YC_OAUTH_TOKEN }}

    

    - name: Build docker images
      run: |
        SERVICES=("rag_service" "orchestrator" "tgbot_service" "validator" "yandexgpt_service")

        for service in "${SERVICES[@]}"; do
            echo "Building $service..."
            
            cd $service
            docker build -t cr.yandex/$REGISTRY_ID/$service:latest .
            docker push cr.yandex/$REGISTRY_ID/$service:latest
            cd ..
            
            container_name="${service//_/-}"
            
            deploy_cmd="yc serverless container revision deploy \
                --container-name $container_name \
                --image cr.yandex/$REGISTRY_ID/$service:latest \
                --service-account-id $SERVICE_ACCOUNT_ID \
                --execution-timeout 1m \
                --cores 1 \
                --memory 512MB \
                --concurrency 4 \
                --environment FOLDER_ID=$FOLDER_ID"
            
        done